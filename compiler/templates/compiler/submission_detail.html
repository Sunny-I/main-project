{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submission #{{ submission.id }} | CodeJudge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/highlight.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <style>
        :root {
            --accent-color: #4361ee;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
            --dark-bg: #212529;
        }
        
        body {
            background-color: #f5f7fb;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        .status-accepted {
            background-color: rgba(46, 204, 113, 0.15);
            color: var(--success-color);
        }
        
        .status-pending {
            background-color: rgba(52, 152, 219, 0.15);
            color: #3498db;
        }
        
        .status-running {
            background-color: rgba(155, 89, 182, 0.15);
            color: #9b59b6;
        }
        
        .status-error {
            background-color: rgba(231, 76, 60, 0.15);
            color: var(--danger-color);
        }
        
        .submission-header {
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            color: white;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        
        .card {
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .test-case-card {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .test-case-card:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .test-case-success {
            border-left: 4px solid var(--success-color);
        }
        
        .test-case-error {
            border-left: 4px solid var(--danger-color);
        }
        
        .test-case-pending {
            border-left: 4px solid #3498db;
        }
        
        .code-container {
            border-radius: 8px;
            overflow: hidden;
        }
        
        .hljs {
            background: #1e1e1e !important;
            padding: 1.5rem !important;
            border-radius: 8px;
        }
        
        .progress-bar {
            transition: width 0.5s ease;
        }
        
        .problem-title {
            color: var(--accent-color);
            transition: color 0.3s ease;
        }
        
        .problem-title:hover {
            color: #3a0ca3;
            text-decoration: none;
        }
        
        .stats-card {
            border-top: 3px solid var(--accent-color);
        }
        
        .back-btn {
            background-color: white;
            color: var(--accent-color);
            border: none;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background-color: var(--accent-color);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-file-code me-2"></i>Submission Details
            </h1>
            <a href="{% url 'problem_detail' submission.problem.slug %}" class="btn back-btn">
                <i class="fas fa-arrow-left me-1"></i> Back to Problem
            </a>
        </div>

        <!-- Submission Header -->
        <div class="submission-header p-4 mb-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h2 class="mb-1">
                        <a href="{% url 'problem_detail' submission.problem.slug %}" class="text-white problem-title">
                            {{ submission.problem.title }}
                        </a>
                    </h2>
                    <p class="mb-0">
                        Submitted by <strong>{{ submission.user.username }}</strong> â€¢ 
                        {{ submission.submitted_at|date:"M d, Y H:i" }}
                    </p>
                </div>
                <div class="col-md-6 text-md-end mt-3 mt-md-0">
                    <span class="status-badge 
                        {% if submission.status == 'AC' %}status-accepted
                        {% elif submission.status == 'P' or submission.status == 'R' %}status-pending
                        {% else %}status-error{% endif %}">
                        {% if submission.status == 'AC' %}
                            <i class="fas fa-check-circle me-1"></i> Accepted
                        {% elif submission.status == 'P' %}
                            <i class="fas fa-clock me-1"></i> Pending
                        {% elif submission.status == 'R' %}
                            <i class="fas fa-sync-alt me-1"></i> Running
                        {% elif submission.status == 'WA' %}
                            <i class="fas fa-times-circle me-1"></i> Wrong Answer
                        {% elif submission.status == 'TLE' %}
                            <i class="fas fa-hourglass-half me-1"></i> Time Limit Exceeded
                        {% elif submission.status == 'CE' %}
                            <i class="fas fa-exclamation-triangle me-1"></i> Compilation Error
                        {% elif submission.status == 'RE' %}
                            <i class="fas fa-bug me-1"></i> Runtime Error
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3 mb-md-0">
                <div class="card h-100 stats-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted mb-1">Runtime</h5>
                        <p class="card-text h3">
                            {% if submission.runtime %}{{ submission.runtime }} ms{% else %}N/A{% endif %}
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3 mb-md-0">
                <div class="card h-100 stats-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted mb-1">Memory</h5>
                        <p class="card-text h3">
                            {% if submission.memory %}{{ submission.memory }} KB{% else %}N/A{% endif %}
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3 mb-md-0">
                <div class="card h-100 stats-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted mb-1">Language</h5>
                        <p class="card-text h3">
                            {{ submission.get_language_display }}
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100 stats-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted mb-1">Test Cases</h5>
                        <p class="card-text h3">
                            {{ submission.passed_test_cases }}/{{ submission.total_test_cases }}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Test Cases Passed</span>
                    <span>{{ submission.passed_test_cases }}/{{ submission.total_test_cases }}</span>
                </div>
                <div class="progress" style="height: 12px; border-radius: 6px;">
                    <div class="progress-bar 
                        {% if submission.passed_test_cases == submission.total_test_cases %}bg-success
                        {% elif submission.passed_test_cases > 0 %}bg-warning
                        {% else %}bg-danger{% endif %}" 
                        role="progressbar" 
                        style="width: {% widthratio submission.passed_test_cases submission.total_test_cases 100 %}%;"
                        aria-valuenow="{% widthratio submission.passed_test_cases submission.total_test_cases 100 %}" 
                        aria-valuemin="0" 
                        aria-valuemax="100">
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Cases Section -->
        <div class="card mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h3 class="h5 mb-0"><i class="fas fa-vial me-2"></i>Test Cases</h3>
                <span class="badge bg-light text-dark">
                    {% if submission.status == 'AC' %}
                        <i class="fas fa-check-circle text-success me-1"></i> All Passed
                    {% elif submission.passed_test_cases > 0 %}
                        <i class="fas fa-exclamation-triangle text-warning me-1"></i> Partial Pass
                    {% else %}
                        <i class="fas fa-times-circle text-danger me-1"></i> Failed
                    {% endif %}
                </span>
            </div>
            <div class="card-body">
                {% if test_case_results %}
                    <div class="row g-3">
                        {% for result in test_case_results %}
                        <div class="col-md-6">
                            <div class="card test-case-card 
                                {% if result.status == 'AC' %}test-case-success
                                {% elif result.status == 'P' or result.status == 'R' %}test-case-pending
                                {% else %}test-case-error{% endif %}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="card-title mb-0">Test Case #{{ forloop.counter }}</h5>
                                        <span class="badge 
                                            {% if result.status == 'AC' %}bg-success
                                            {% elif result.status == 'P' or result.status == 'R' %}bg-primary
                                            {% else %}bg-danger{% endif %}">
                                            {% if result.status == 'AC' %}Passed
                                            {% elif result.status == 'P' %}Pending
                                            {% elif result.status == 'R' %}Running
                                            {% elif result.status == 'WA' %}Wrong
                                            {% elif result.status == 'TLE' %}Timeout
                                            {% elif result.status == 'CE' %}Compile
                                            {% elif result.status == 'RE' %}Runtime
                                            {% endif %}
                                        </span>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <div class="row">
                                            <div class="col-6">
                                                <small class="text-muted">Runtime</small>
                                                <p class="mb-0">
                                                    {% if result.runtime %}{{ result.runtime }} ms{% else %}--{% endif %}
                                                </p>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Memory</small>
                                                <p class="mb-0">
                                                    {% if result.memory %}{{ result.memory }} KB{% else %}--{% endif %}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {% if result.status != 'AC' and result.error_message %}
                                    <div class="mt-3">
                                        <small class="text-muted">Error Message</small>
                                        <pre class="bg-light p-2 mt-1 rounded" style="font-size: 0.8rem;">{{ result.error_message|truncatechars:120 }}</pre>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="mt-3 text-end">
                                        <button class="btn btn-sm btn-outline-primary" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#testCaseModal{{ forloop.counter }}">
                                            <i class="fas fa-search me-1"></i> Details
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-vial fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No test cases executed yet</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Code Section -->
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h3 class="h5 mb-0"><i class="fas fa-code me-2"></i>Submitted Code</h3>
            </div>
            <div class="card-body p-0">
                <div class="d-flex justify-content-between align-items-center px-4 py-2 bg-light border-bottom">
                    <div>
                        <span class="badge bg-secondary">{{ submission.get_language_display }}</span>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="copyCodeBtn">
                            <i class="fas fa-copy me-1"></i> Copy Code
                        </button>
                    </div>
                </div>
                <div class="code-container">
                    <pre><code class="language-{{ submission.language }}">{{ submission.code }}</code></pre>
                </div>
            </div>
        </div>

        <!-- Visualization -->
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h3 class="h5 mb-0"><i class="fas fa-chart-bar me-2"></i>Performance Metrics</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="runtimeChart"></canvas>
                    </div>
                    <div class="col-md-6">
                        <canvas id="memoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Case Modals -->
    {% for result in test_case_results %}
    <div class="modal fade" id="testCaseModal{{ forloop.counter }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Test Case #{{ forloop.counter }} Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header py-2 bg-light">
                                    <h6 class="mb-0">Input</h6>
                                </div>
                                <div class="card-body p-3">
                                    <pre class="mb-0" style="white-space: pre-wrap;">{{ result.test_case.input }}</pre>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header py-2 bg-light">
                                    <h6 class="mb-0">Expected Output</h6>
                                </div>
                                <div class="card-body p-3">
                                    <pre class="mb-0" style="white-space: pre-wrap;">{{ result.test_case.expected_output }}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header py-2 bg-light">
                            <h6 class="mb-0">Your Output</h6>
                        </div>
                        <div class="card-body p-3">
                            {% if result.output %}
                                <pre class="mb-0" style="white-space: pre-wrap;">{{ result.output }}</pre>
                            {% else %}
                                <p class="mb-0 text-muted">No output generated</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if result.error_message %}
                    <div class="card border-danger">
                        <div class="card-header py-2 bg-danger text-white">
                            <h6 class="mb-0">Error Message</h6>
                        </div>
                        <div class="card-body p-3">
                            <pre class="mb-0 text-danger" style="white-space: pre-wrap;">{{ result.error_message }}</pre>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize code highlighting
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        });
        
        // Copy code button
        document.getElementById('copyCodeBtn').addEventListener('click', function() {
            const code = document.querySelector('.code-container code').innerText;
            navigator.clipboard.writeText(code).then(() => {
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-check me-1"></i> Copied!';
                setTimeout(() => {
                    this.innerHTML = originalText;
                }, 2000);
            });
        });
        
        // Charts
        document.addEventListener('DOMContentLoaded', function() {
            // Runtime distribution chart
            const runtimeCtx = document.getElementById('runtimeChart').getContext('2d');
            new Chart(runtimeCtx, {
                type: 'bar',
                data: {
                    labels: ['Min', 'Avg', 'Max'],
                    datasets: [{
                        label: 'Runtime (ms)',
                        data: [5, {{ submission.runtime|default:"0" }}, 50],
                        backgroundColor: 'rgba(67, 97, 238, 0.5)',
                        borderColor: 'rgba(67, 97, 238, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Runtime Distribution'
                        }
                    }
                }
            });
            
            // Memory usage chart
            const memoryCtx = document.getElementById('memoryChart').getContext('2d');
            new Chart(memoryCtx, {
                type: 'line',
                data: {
                    labels: ['Test 1', 'Test 2', 'Test 3', 'Test 4', 'Test 5'],
                    datasets: [{
                        label: 'Memory (KB)',
                        data: [10, 25, 18, 32, {{ submission.memory|default:"0" }}],
                        backgroundColor: 'rgba(46, 204, 113, 0.2)',
                        borderColor: 'rgba(46, 204, 113, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Memory Usage'
                        }
                    }
                }
            });
        });
        
        // Auto-refresh for pending submissions
        {% if submission.status == 'P' or submission.status == 'R' %}
        setTimeout(function() {
            window.location.reload();
        }, 5000); // Refresh every 5 seconds
        {% endif %}
    </script>
</body>
</html>